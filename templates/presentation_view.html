{% extends 'base.html' %}

{% block title %}DMD Panel Administratora - Zarządzanie Prezentacjami{% endblock %}
{% block scripts%}
<script>
    const syncMonitors = {};
    const SYNC_POLL_INTERVAL = 5000;       // co 5 sekund
    const SYNC_POLL_TIMEOUT  = 5 * 60 * 1000; // max 5 minut

    // mapujemy postId -> timestamp startu odliczania (ms)
    const SYNC_COUNTDOWN_SECONDS = 7 * 60; // 7 minut
    const syncCountdowns = {}; // np. { "39": 1700000000000 }

    
</script>
{% endblock %}

{% block addButton %}
<!-- d-block d-sm-none tylko na średnim sm+ -->
<div class="d-block d-sm-none mt-2">
    <div class="add-button-green ps-3">
        <a  data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
            <i class="bi bi-plus-square-fill" style="font-size: 15pt; color: #0e900e !important;"></i>
        </a>
    </div>
</div>
<!-- d-none d-sm-block d-lg-none tylko na średnim lg+ -->
<div class="d-none d-sm-block d-lg-none mt-2">
    <div class="add-button-green ps-3">
        <a  data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
            <i class="bi bi-plus-square-fill" style="font-size: 15pt; color: #0e900e !important;"></i>
        </a>
    </div>
</div>
<!-- d-none d-xl-block tylko na pełnym xl+ -->
<div class="d-none d-lg-block mt-2">
    <div class="add-button-green ps-3">
        <a  data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
            <i class="bi bi-plus-square-fill" style="font-size: 20pt; color: #0e900e !important;"></i>
        </a>
    </div>
</div>

{% endblock %}
{% block navbarTitle %}
<!-- d-block d-sm-none tylko na średnim sm+ -->
<div class="d-block d-sm-none mt-2">
    <div style="display: flex; justify-content: space-between;">
        <a data-bs-toggle="offcanvas" data-bs-target="#offcanvasTop_sm" aria-controls="offcanvasTop_sm">
            <img 
                src="../static/img/logotypy_dmd_domy.png" 
                alt="DMD" 
                style="margin-left: 2px !important; padding-right: 10px; max-height: 22px;"/>
        </a>

    </div>
</div>
<!-- d-none d-sm-block d-lg-none tylko na średnim lg+ -->
<div class="d-none d-sm-block d-lg-none mt-2">
    <div style="display: flex; justify-content: space-between;">
        <a data-bs-toggle="offcanvas" data-bs-target="#offcanvasTop_lg" aria-controls="offcanvasTop_lg">
            <img 
                src="../static/img/logotypy_dmd_domy.png" 
                alt="DMD" 
                style="margin-left: 5px !important; padding-right: 10px; max-height: 35px;"
                />
        </a>
        <a 
            class="nav-link active dark-mode" 
            aria-current="page" 
            style="max-height: 40px; font-size: 15px; font-weight: 100;"
            href="#">
            Preznetacje
        </a>
    </div>
</div>
<!-- d-none d-xl-block tylko na pełnym xl+ -->
<div class="d-none d-lg-block mt-2">
    <div style="display: flex; justify-content: space-between;">
        <a data-bs-toggle="offcanvas" data-bs-target="#offcanvasTop_xl" aria-controls="offcanvasTop_xl">
            <img 
                src="../static/img/logotypy_dmd_domy.png" 
                alt="DMD" 
                style="margin-left: 10px !important; padding-right: 10px; max-height: 40px;"/>
        </a>
        <a 
            class="nav-link active dark-mode" 
            aria-current="page" 
            style="max-height: 45px; font-size: 20px; font-weight: 100;"
            href="#">
            Zarządzanie Prezentacjami
        </a>
    </div>
</div>
{% endblock %}

{% block tableHeader %}
                        <div>
                            <div class="row klej formatuj-header">
                                <div class="d-none d-lg-block" style="max-width: 30px;">
                                    #
                                </div>
                                <!-- responsywny start -->
                                <div class="d-lg-none" style="max-width: 30px;">
                                    <i class="bi bi-incognito"></i>
                                </div>
                                <!-- responsywny koniec -->
                                <div  class="col-xl-8 col-lg-6 col-sm-8">
                                    Tytuł
                                </div>
                                <div  class="d-none d-lg-block" style="max-width: 120px;">
                                    Autor
                                </div>
                                <div  class="d-none d-xl-block" style="max-width: 150px;">
                                    Slot
                                </div>
                                <div  class="d-none d-lg-block" style="max-width: 120px;">
                                    Status
                                </div>
                                <div  class="d-none d-xl-block" style="max-width: 80px;">
                                    <i class="bi bi-incognito"></i>
                                </div>
                                <div  class="d-none d-lg-block" style="max-width: 150px;">
                                    Data publikacji
                                </div>
                                <div  class="text-end" style="max-width: 80px;">
                                    <i class="bi bi-person-gear"></i> Akcja 
                                </div>
                            </div>
                        </div>
{% endblock %}
{% block tableContent%}
                        <!-- OFFCANVANSE RIGHT ADD NEW POST -->
                        <div class="offcanvas offcanvas-end bg-dark oc-width" tabindex="-1" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
                            <div class="offcanvas-header">
                                <h4 class="offcanvas-title" id="offcanvasRightLabel">Dodawanie nowej prezentacji.</h4>
                                <button type="button" class="btn-close btn-close-white"  data-bs-dismiss="offcanvas" aria-label="Close"></button>
                            </div>
                            <div class="offcanvas-body">
                                <form id="presentation_9999999">
                                    <!-- title -->
                                    <div class="form-floating mb-3">
                                        <input 
                                            type="text" 
                                            value=""
                                            class="form-control bg-dark formatuj-maly-font" 
                                            style="color:#c2c2c2; border:#6a6a6a solid 1px;"
                                            id="title_9999999" 
                                            name="title" 
                                            placeholder="Tytuł Prezentacji"
                                            required />
                                        <label for="title_9999999">Tytuł Prezentacji</label>
                                    </div>
                                    <!-- description -->
                                    <label class="form-label mt-2">Opis Prezentacji</label>
                                    <div 
                                        id="description_9999999" 
                                        contenteditable="true" 
                                        class="form-control bg-dark formatuj-maly-font" 
                                        style="color:#c2c2c2; border:#6a6a6a solid 1px; padding:10px; min-height:100px;">
                                    </div>
                                    <div class="no-border formatuj-maly-font fadeIn mb-3">
                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja dla roli GOLD. Materiał: [opis treści]. Przeznaczenie: prezentacje strategiczne i zarządcze. Czas trwania: [czas].')">
                                            Szablon GOLD – prezentacja strategiczna
                                        </a>

                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja SILVER. Materiał: [opis treści]. Zastosowanie: wewnętrzne informacje operacyjne, statusy, raporty. Czas trwania: [czas].')">
                                            Szablon SILVER – informacje operacyjne
                                        </a>

                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja GREEN. Materiał: [opis treści]. Zastosowanie: treści ogólne, marketingowe, firmowe, dla gości. Czas trwania: [czas].')">
                                            Szablon GREEN – ogólna firmowa
                                        </a>

                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja budowlana / techniczna. Zawartość: [zakres materiału]. Dla kogo: [dział / dział budowy]. Czas: [czas].')">
                                            Szablon Techniczny
                                        </a>

                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja marketingowa. Przekaz: [hasło / temat przewodni]. Cele: [cele prezentacji]. Czas: [czas].')">
                                            Szablon Marketingowy
                                        </a>

                                        <a class="ms-2" href="javascript:void(0);" 
                                        onClick="applyTemplate('description_9999999', 
                                        'Prezentacja dla Zarządu. Temat: [temat]. Kluczowe punkty: [punkty]. Przewidywany czas: [czas].')">
                                            Szablon Zarząd / Executive
                                        </a>
                                    </div>
                                    <!-- slot -->
                                    <div class="mb-3">
                                        <select 
                                            class="form-select dark-mode mb-2 mt-2" 
                                            style="max-height: 30px; font-size: 12px;" 
                                            id="slot_9999999" 
                                            name="slot"
                                            required>

                                            <option value="">Wybierz slot prezentacji</option>

                                            <option value="green">GREEN — treści ogólne / firmowe</option>
                                            {% if userperm['presentation-silver'] == 1 %}<option value="silver">SILVER — informacje operacyjne</option>{% endif %}
                                            {% if userperm['presentation-gold'] == 1 %}<option value="gold">GOLD — prezentacje strategiczne</option>{% endif %}

                                        </select>
                                    </div>


                                    <!-- moduł VideoDropBox -->
                                    <label class="form-label">Plik wideo prezentacji</label>
                                    <p class="small text-muted mb-0">
                                        Obsługiwany format: <strong>MP4 (H.264 + AAC)</strong>, maks. <strong>20 minut</strong>, maks. <strong>2 GB</strong>.
                                    </p>
                                    <div id="9999999-drop-area" class="drop-area-video m-4">
                                        <div id="9999999-videoSummary" ><p style="font-size: 80px;"><i class="bi bi-cloud-plus"></i></p></div>
                                                                                
                                    </div>

                                    <script>
                                        // globalna mapa, zadeklarowana raz, nie w funkcji!
                                        window.videoDropBox = window.videoDropBox || {};

                                        document.addEventListener('DOMContentLoaded', function () {
                                            window.videoDropBox["9999999"] = new VideoDropBox('9999999');
                                            console.log('init videoDropBox[9999999]', window.videoDropBox["9999999"]);
                                        });
                                    </script>
                                    
                                    <input type="hidden" name="OfferID" id="OfferID_9999999" value="" />

                                    <input type="hidden" name="author" id="author_9999999" value="{{ username }}" />

                                    <!-- metadane -->
                                    <input type="hidden" name="video_duration_sec" id="9999999-videodurationsec" value="" />
                                    <input type="hidden" name="video_width" id="9999999-videowidth" value="" />
                                    <input type="hidden" name="video_height" id="9999999-videoheight" value="" />
                                    
                                    <input type="hidden" name="target" id="target_9999999" value="presentation" />

                                    <!-- pasek progresu dla NOWEJ prezentacji -->
                                    <div id="uploadProgress_9999999" class="progress d-none mt-3" style="height: 5px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                            role="progressbar" 
                                            style="width: 0%;" 
                                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>

                                    <button 
                                        type="button" 
                                        class="btn btn-success btn-sm mt-2" 
                                        style="max-height: 30px; font-size: 12px;" 
                                        onclick="prepareAndSubmitPresentation('9999999', false)"
                                    >
                                        Dodaj prezentację
                                    </button>


                                </form>
                            </div>
                        </div>

                        {% for post_data in presentations_list %}
                            {% set post_id  = post_data['id'] %}
                            <!-- linia contentu tabeli ciemna-->
                            <div class="presentation-row" data-presentation-id="{{ post_id }}">
                                <div class="row klej {% if loop.index is even %}formatuj-light-line{% else %}formatuj-dark-line{% endif %}" >
                                    <div class="d-none d-lg-block formatuj-maly-font" style="max-width: 30px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        {{post_id}}
                                    </div>
                                    <div class="d-lg-none" style="max-width: 30px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        {% if post_data['status'] == 1 %}
                                            <span class="text-warning"><i class="bi bi-lightbulb-fill"></i></span>
                                        {% else %}
                                            <span class="text-secondary"><i class="bi bi-lightbulb-fill"></i></span>
                                        {% endif %}
                                    </div>
                                    <div  class="col-xl-8 col-md-8 col-sm-10 formatuj-maly-font" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                            {{post_data['title']}}
                                        </a>
                                        
                                    </div>
                                    <div  class="d-none d-lg-block"  style="max-width: 120px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                            <span class="display-6 formatuj-maly-font">{{post_data['author']}}</span>
                                        </a>
                                    </div>
                                    
                                    <div  class="d-none d-xl-block"  style="max-width: 150px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                            <span class="display-6 formatuj-maly-font">{{post_data['slot']|upper}}</span>
                                        </a>
                                    </div>
                                    <div  class="d-none d-lg-block" style="max-width: 120px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                            {% if post_data['status'] == 1 %}
                                                <span class="text-warning"><i class="bi bi-lightbulb-fill"></i></span>
                                            {% else %}
                                                <span class="text-secondary"><i class="bi bi-lightbulb-fill"></i></span>
                                            {% endif %}
                                        </a>
                                    </div>
                                    <div class="d-none d-xl-block" style="max-width: 80px;"
                                        data-bs-toggle="collapse"
                                        href="#collapse_id_{{post_id}}"
                                        role="button" aria-expanded="false"
                                        aria-controls="collapse_id_{{post_id}}">

                                        <div class="row" id="sync_status_row_{{post_id}}">
                                            {# Na start możesz wyrenderować cokolwiek, ale JS i tak to nadpisze #}
                                            <span class="text-muted">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </span>
                                        </div>
                                    </div>


                                    <div class="d-none d-lg-block" style="max-width: 150px;" data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                        <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                            <span class="display-6 formatuj-maly-font">{{post_data['updated_at']}}</span>
                                        </a>
                                    </div>
                                    <div class="text-end" style="max-width: 80px;">
                                        <form 
                                            method="POST" 
                                            id="remove_presentation_{{post_id}}" 
                                            action="{{ url_for('remove_presentation') }}" 
                                            onsubmit="return confirm('Uwaga: usunięcie prezentacji spowoduje skasowanie rekordu i powiązanego pliku wideo z serwera. Czy na pewno chcesz kontynuować?');">

                                            <a data-bs-toggle="collapse" href="#collapse_id_{{post_id}}" role="button" aria-expanded="false" aria-controls="collapse_id_{{post_id}}">
                                                <i class="bi bi-chevron-double-down" style="color: rgb(89, 176, 90) !important;"></i>
                                            </a>

                                            <a data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling_{{post_id}}" aria-controls="offcanvasScrolling_{{post_id}}">
                                                <i class="bi bi-pencil" style="color: #7eb5cc !important;"></i>
                                            </a>

                                            <input type="hidden" name="UserName" id="UserName_{{post_id}}" value="{{ username }}"/>
                                            <input type="hidden" name="PostID"   id="PostID_{{post_id}}"   value="{{ post_id }}"/>

                                            <button type="submit" class="custom-icon-button">
                                                <i class="bi bi-trash-fill" style="color: rgb(149, 47, 47) !important;"></i>
                                            </button>
                                        </form>

                                    </div>
                                </div>
                            </div>
                            <!-- offcanvanse left -->
                            <div class="offcanvas offcanvas-start bg-dark oc-width" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling_{{post_id}}" aria-labelledby="offcanvasScrollingLabel">
                                <div class="offcanvas-header">
                                <h4 class="offcanvas-title" id="offcanvasScrollingLabel">Edycja Prezentacji o id: {{post_id}}</h4>
                                <button type="button" class="btn-close btn-close-white"  data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                </div>
                                <div class="offcanvas-body formatuj-maly-font">
                                    <div class="tylko-klej">
                                        <div style="color:#6a6a6a;">
                                            <form id="presentation_{{post_id}}">
                                                <!-- title -->
                                                <div class="form-floating mb-3">
                                                    <input 
                                                        type="text"
                                                        value="{{ post_data['title'] }}" 
                                                        class="form-control bg-dark formatuj-maly-font" 
                                                        style="color:#c2c2c2; border:#6a6a6a solid 1px;"
                                                        id="title_{{post_id}}" 
                                                        name="title" 
                                                        placeholder="Tytuł Prezentacji"
                                                        required
                                                    />
                                                    <label for="title_{{post_id}}">Tytuł Prezentacji</label>
                                                </div>

                                                <!-- description -->
                                                <label class="form-label mt-2">Opis Prezentacji</label>

                                                <div 
                                                    id="description_{{post_id}}" 
                                                    contenteditable="true" 
                                                    class="form-control bg-dark formatuj-maly-font" 
                                                    style="color:#c2c2c2; border:#6a6a6a solid 1px; padding:10px; min-height:100px;">
                                                    {{ post_data['description'] | safe }}
                                                </div>

                                                <div class="no-border formatuj-maly-font fadeIn mb-3">

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja dla roli GOLD. Materiał: [opis treści]. Przeznaczenie: prezentacje strategiczne i zarządcze. Czas trwania: [czas].')">
                                                        Szablon GOLD – prezentacja strategiczna
                                                    </a>

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja SILVER. Materiał: [opis treści]. Zastosowanie: wewnętrzne informacje operacyjne, statusy, raporty. Czas trwania: [czas].')">
                                                        Szablon SILVER – informacje operacyjne
                                                    </a>

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja GREEN. Materiał: [opis treści]. Zastosowanie: treści ogólne, marketingowe, firmowe, dla gości. Czas trwania: [czas].')">
                                                        Szablon GREEN – ogólna firmowa
                                                    </a>

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja budowlana / techniczna. Zawartość: [zakres materiału]. Dla kogo: [dział / dział budowy]. Czas: [czas].')">
                                                        Szablon Techniczny
                                                    </a>

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja marketingowa. Przekaz: [hasło / temat przewodni]. Cele: [cele prezentacji]. Czas: [czas].')">
                                                        Szablon Marketingowy
                                                    </a>

                                                    <a class="ms-2" href="javascript:void(0);" 
                                                    onClick="applyTemplate('description_{{post_id}}', 
                                                    'Prezentacja dla Zarządu. Temat: [temat]. Kluczowe punkty: [punkty]. Przewidywany czas: [czas].')">
                                                        Szablon Zarząd / Executive
                                                    </a>
                                                </div>

                                                <!-- slot -->                                                
                                                <div class="mb-3">
                                                    
                                                    <div 
                                                        class="slot-info-{% if post_data.slot == 'gold' %}gold{% elif post_data.slot == 'silver' %}silver{% else %}green{% endif %}" 
                                                        role="alert">
                                                        SLOT: {{post_data['slot']|upper}}
                                                    </div>
                                                    
                                                </div>
                                                <input type="hidden" name="slot" id="slot_{{post_id}}" value="{{post_data['slot']}}" />


                                                            
                                                <!-- moduł VideoDropBox (edycja prezentacji) -->
                                                <label class="form-label">Plik wideo prezentacji</label>
                                                <p class="small text-muted mb-0">
                                                    Obsługiwany format: <strong>MP4 (H.264 + AAC)</strong>, maks. <strong>20 minut</strong>, maks. <strong>2 GB</strong>.
                                                </p>
                                                
                                                <div id="{{post_id}}-drop-area" class="drop-area-video m-4">
                                                    <div id="{{post_id}}-videoSummary" class="mt-2">
                                                        <p class="text-primary"><i class="bi bi-file-earmark-play"></i> {{post_id}}.mp4 <i class="bi bi-pause"></i> <i class="bi bi-arrows-angle-expand"></i> ({{post_data.video_width}} x {{post_data.video_height}}) <i class="bi bi-pause"></i> <i class="bi bi-clock-history"></i> {{post_data.video_duration_sec}}</p>
                                                        <p style="font-size: 80px;"><i class="bi bi-cloud-plus"></i></p>
                                                        <p class="text-info small">Załaduj ponownie</p>
                                                    </div>
                                                </div>

                                                <script>
                                                    document.addEventListener('DOMContentLoaded', () => {
                                                        const existingVideoUrl = "{{ post_data['video_url'] if post_data.get('video_url') else '' }}";

                                                        window.videoDropBox["{{post_id}}"] = new VideoDropBox(
                                                            "{{post_id}}",
                                                            existingVideoUrl || null
                                                        );
                                                    });
                                                </script>

                                                
                                                <input type="hidden" name="OfferID" id="OfferID_{{post_id}}" value="{{post_id}}" />

                                                <input type="hidden" name="author" id="author_{{post_id}}" value="{{ username }}" />
                                                <input type="hidden" name="target" id="target_{{post_id}}" value="{{ post_data['target'] }}" />

                                                <!-- metadane -->
                                                <input type="hidden" name="video_duration_sec" id="{{post_id}}-videodurationsec" value="" />
                                                <input type="hidden" name="video_width" id="{{post_id}}-videowidth" value="" />
                                                <input type="hidden" name="video_height" id="{{post_id}}-videoheight" value="" />
                                                
                                                <!-- pasek progresu dla EDYCJI prezentacji -->
                                                <div id="uploadProgress_{{post_id}}" class="progress d-none mt-3" style="height: 5px;">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                        role="progressbar" 
                                                        style="width: 0%;" 
                                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>

                                                <button 
                                                    type="button" 
                                                    class="btn btn-success btn-sm mt-2" 
                                                    style="max-height: 30px; font-size: 12px;" 
                                                    onclick="prepareAndSubmitPresentation('{{post_id}}', true)"
                                                >
                                                    Zapisz prezentację
                                                </button>


                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- collapse start -->

                            <div class="sub-panel rogi collapse formatyj-maly-wiersz p-2" id="collapse_id_{{post_id}}">

                                <div class="row">
                                    <div class="col-lg-4 col-sm-12">

                                        {% if post_data.get('video_path') %}
                                            <video 
                                                src="{{ post_data['video_path'] }}"
                                                class="img-thumbnail object-fit-cover rounded bg-dark mb-2 w-100"
                                                style="max-height: 260px;"
                                                controls
                                                muted>
                                                Twoja przeglądarka nie obsługuje elementu wideo.
                                            </video>
                                        {% else %}
                                            <div class="img-thumbnail d-flex align-items-center justify-content-center rounded bg-dark mb-2"
                                                style="height: 180px; color:#888;">
                                                Brak przypisanego pliku wideo
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-lg-4 col-sm-12 career-properties-other">
                                        <h5 class="mb-1">
                                            {{ post_data['title'] }}
                                        </h5>
                                        <p class="text-muted mb-2" style="font-size: 12px;">
                                            Slot: <strong>{{ post_data['slot']|upper }}</strong>
                                            {% if post_data.get('target') %}
                                                &nbsp;|&nbsp; Target: <strong>{{ post_data['target'] }}</strong>
                                            {% endif %}
                                            {% if post_data.get('created_at') %}
                                                &nbsp;|&nbsp; Utworzono: {{ post_data['created_at'] }}
                                            {% endif %}
                                        </p>

                                        <h6>Opis Prezentacji</h6>
                                        <p>{{ post_data['description']|safe }}</p>

                                        <p class="mb-0">Autor: {{ post_data['author'] }}</p>
                                        {% if post_data.get('created_by') %}
                                            <p class="mb-0">Utworzone przez: {{ post_data['created_by'] }}</p>
                                        {% endif %}
                                        <div class="mt-2">
                                            <form action="{{ url_for('update_presentation_status') }}" method="POST">
                                                <input type="hidden" name="PostID" value="{{ post_id }}" />
                                                <input type="hidden" name="Status" value="1" />
                                                <input type="hidden" name="slot" value="{{ post_data['slot'] }}" />
                                                {% if post_data['status'] == 0 %}
                                                    <div class="col me-1 mb-1">
                                                        <button 
                                                            type="submit" 
                                                            class="btn btn-outline-success btn-sm" 
                                                            style="max-height: 30px; font-size: 12px;">
                                                            Aktywuj prezentację
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </form>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-sm-12">

                                        {# USTALAMY KOLOR i TEKST STATUSU #}
                                        {% set card_class = "msg-light text-muted border-0" %}
                                        {% set status_title = "Nieznany status" %}
                                        {% set status_desc  = "Brak zdefiniowanego stanu synchronizacji dla tej prezentacji." %}

                                        {# 4. Rozłączony – był kiedyś poprawnie opublikowany, ale teraz odłączony #}
                                        {% if post_data['last_sync_status'] == 'disconnected' and post_data['published_at'] and post_data['status'] != 1 %}
                                            {% set card_class = "msg-danger" %}
                                            {% set status_title = "Rozłączony" %}
                                            {% set status_desc  = "Ta prezentacja została zastąpiona inną w tym slocie. Ten rekord jest odłączony." %}

                                        {# 1. Nieaktywny + nigdy nie zsynchronizowany (brak published_at) #}
                                        {% elif post_data['status'] == 0 and post_data['sync'] == 0 and not post_data['published_at'] %}
                                            {% set card_class = "msg-secondary" %}
                                            {% set status_title = "Oczekuje na pierwszą synchronizację" %}
                                            {% set status_desc  = "Prezentacja jest nieaktywna i nie została jeszcze nigdy poprawnie zsynchronizowana z RPi." %}

                                        {# 2. Aktywny + niezsynchronizowany #}
                                        {% elif post_data['status'] == 1 and post_data['sync'] == 0 %}
                                            {% set card_class = "msg-info" %}
                                            {% set status_title = "Wymagana synchronizacja" %}
                                            {% set status_desc  = "Prezentacja jest aktywna w panelu, ale RPi nie ma jeszcze aktualnej wersji pliku." %}
                                        
                                        {# 5. Ostation Odmutowany + nie disconnected + data publikacji #}
                                        {% elif post_data['status'] == 0 and post_data['last_sync_status'] != 'disconnected' and post_data['published_at'] %}
                                            {% set card_class = "msg-warning" %}
                                            {% set status_title = "Odłączanie slotu" %}
                                            {% set status_desc  = "Prezentacja nie jest aktywna w panelu, ale RPi nie zgłosił jeszcze udanej aktualizacji." %}

                                        {# 3. Zsynchronizowany + aktywny #}
                                        {% elif post_data['status'] == 1 and post_data['sync'] == 1 %}
                                            {% set card_class = "msg-success" %}
                                            {% set status_title = "Zsynchronizowano" %}
                                            {% set status_desc  = "Prezentacja jest aktywna i poprawnie zsynchronizowana z RPi." %}
                                        {% endif %}

                                        <div class="msg card-sync-status {{ card_class }}">
                                            <div class="p-2">

                                                <h6 class="card-title mb-1">{{ status_title }}</h6>
                                                <p class="card-text mb-1">{{ status_desc }}</p>

                                                <hr class="my-1">

                                                <!-- Opublikowano -->
                                                <p class="card-text mb-1">
                                                    <small><strong>Opublikowano:</strong>
                                                        {% if post_data['published_at'] %}
                                                            <i class="bi bi-calendar-check text-success"></i>
                                                            <span id="published_at_{{post_id}}">{{ post_data['published_at'] }}</span>
                                                        {% else %}
                                                            <i class="bi bi-dash-circle text-muted"></i>
                                                            <span id="published_at_{{post_id}}">brak</span>
                                                        {% endif %}
                                                    </small>
                                                </p>

                                                <!-- Ostatnia synchronizacja -->
                                                <p class="card-text mb-1">
                                                    <small>
                                                        <strong>Ostatnia synchronizacja:</strong>
                                                        {% if post_data['last_sync_at'] %}
                                                            <i class="bi bi-clock-history text-success"></i>
                                                            {{ post_data['last_sync_at'] }}
                                                        {% else %}
                                                            <i class="bi bi-dash-circle text-muted"></i>
                                                            brak
                                                        {% endif %}
                                                    </small>
                                                </p>

                                                <!-- Status techniczny -->
                                                <p class="card-text mb-1">
                                                    <small>
                                                        <strong>Status techniczny:</strong>
                                                        {% if post_data['last_sync_status'] %}
                                                            <i class="bi bi-info-circle text-info"></i>
                                                            {{ post_data['last_sync_status'] }}
                                                        {% else %}
                                                            <i class="bi bi-dash-circle text-muted"></i>
                                                        {% endif %}
                                                    </small>
                                                </p>

                                                <!-- Ostatni błąd -->
                                                <p class="card-text mb-2">
                                                    <small>
                                                        <strong>Ostatni błąd:</strong>
                                                        {% if post_data['last_sync_error'] %}
                                                            <i class="bi bi-bug text-danger"></i>
                                                            {{ post_data['last_sync_error'] }}
                                                        {% else %}
                                                            <i class="bi bi-dash-circle text-muted"></i>
                                                        {% endif %}
                                                    </small>
                                                </p>

                                                <!-- Guzik wymuszenia synchronizacji -->
                                                {% if post_data['status'] == 1 and post_data['sync'] == 1 %}
                                                    <button class="btn btn-dark btn-sm mt-1 d-flex align-items-center justify-content-center"
                                                            onclick="forceResync('{{ post_id }}', '{{ post_data.slot }}')"
                                                            style="font-size: 30px !important; color: #33f5ff;"
                                                            id="btn_force_resync_{{ post_id }}">
                                                        <i class="bi bi-arrow-repeat me-1"></i>
                                                    </button>
                                                {% endif %}

                                            </div>
                                        </div>


                                    </div>

                                </div>
                            </div>

                            <!-- collapse end -->
                        {% endfor %}
                        <!-- Paginacja -->
                        <span class="formatuj-maly-logout">{{ pagination.info }}</span>
                        <div class="pagination formatuj-margin-top">
                            <nav aria-label="Page navigation example">                            
                                <ul class="pagination justify-content-center dark-mode">
                                    <li class="page-item">{{ pagination.prev }}</li>
                                    <li class="page-item">{{ pagination.links }}</li>
                                    <li class="page-item">{{ pagination.next }}</li>
                                </ul>
                            </nav>
                        </div>
{% endblock %}
{% block bottom_script %}
<div class="toast-container position-fixed bottom-0 end-0 p-3 z-3" id="main-winToast">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <img src="../static/img/logotypy_dmd_domy.png" class="rounded me-2" alt="..." style="width: 40px; height: 20px;">
        <strong class="me-auto" id="toast-title">System</strong>
        <small class="text-muted" id="toast-time">Teraz</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Zamknij"></button>
      </div>
      <div class="toast-body" id="toast-body">Tutaj treść komunikatu</div>
    </div>
</div>
<script>
    class VideoDropBox { // v1.0 na bazie FotoDropBox
        constructor(formId, existingVideoUrl = null) {
            this.formId = formId;

            this.dropArea    = document.getElementById(`${formId}-drop-area`);
            this.summaryBox  = document.getElementById(`${formId}-videoSummary`);
            this.videoDurationSec  = document.getElementById(`${formId}-videodurationsec`);
            this.videoWidth  = document.getElementById(`${formId}-videowidth`);
            this.videoHeight  = document.getElementById(`${formId}-videoheight`);
            this.file        = null;
            this.existingVideoUrl = existingVideoUrl;

            if (!this.dropArea || !this.summaryBox) {
                console.warn('VideoDropBox: brak wymaganych elementów w DOM');
                return;
            }

            if (!this.checkDragAndDropSupport()) {
                showToast('Przeglądarka nie obsługuje funkcji przeciągania i upuszczania plików. Użyj przycisku wyboru pliku.', 'error');
            }

            // ukryty input file
            this.fileInput = document.createElement('input');
            this.fileInput.type = 'file';
            this.fileInput.accept = 'video/mp4'; // tylko MP4
            this.fileInput.multiple = false;
            this.fileInput.style.display = 'none';
            document.body.appendChild(this.fileInput);

            this.dropArea.addEventListener('click', () => this.fileInput.click());
            this.fileInput.addEventListener('change', (e) => this.handleFileInput(e));

            this.initEventListeners();

            if (this.existingVideoUrl) {
                this.renderExistingVideoInfo();
            }
        }

        // --- helpers ---

        checkDragAndDropSupport() {
            const div = document.createElement('div');
            return ('draggable' in div) || ('ondragstart' in div && 'ondrop' in div);
        }

        initEventListeners() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                this.dropArea.addEventListener(eventName, (e) => this.preventDefaults(e), false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                this.dropArea.addEventListener(eventName, () => this.highlight(), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                this.dropArea.addEventListener(eventName, () => this.unhighlight(), false);
            });

            this.dropArea.addEventListener('drop', (e) => this.handleDrop(e), false);
        }

        preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        highlight() {
            this.dropArea.classList.add('highlight');
        }

        unhighlight() {
            this.dropArea.classList.remove('highlight');
        }

        handleDrop(e) {
            this.preventDefaults(e);
            const dt    = e.dataTransfer;
            const files = dt && dt.files ? dt.files : [];
            if (!files.length) return;
            this.processFile(files[0]); // tylko pierwszy plik
        }

        handleFileInput(e) {
            const files = e.target.files || [];
            if (!files.length) return;
            this.processFile(files[0]); // tylko jeden plik
        }

        // --- główna logika ---

        processFile(file) {
            if (!this.validateType(file)) {
                alert('Obsługiwane są wyłącznie pliki MP4.');
                return;
            }

            this.file = file;
            this.analyzeFile(file);
        }

        validateType(file) {
            // sprawdzamy typ MIME i rozszerzenie
            const isMp4Mime = file.type === 'video/mp4';
            const ext       = this.getFileExtension(file.name).toLowerCase();
            const isMp4Ext  = ext === 'mp4';
            return isMp4Mime || isMp4Ext;
        }

        analyzeFile(file) {
            // standard z „Architektury 0.1”
            const MAX_SIZE_BYTES    = 2 * 1024 * 1024 * 1024; // 2 GB
            const MAX_DURATION_SEC  = 20 * 60;                // 20 min
            const RECOMM_WIDTH      = 1920;
            const RECOMM_HEIGHT     = 1080;

            const url   = URL.createObjectURL(file);
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.src = url;

            video.onloadedmetadata = () => {
                URL.revokeObjectURL(url);

                const duration = isFinite(video.duration) ? video.duration : null;
                const width    = video.videoWidth || 0;
                const height   = video.videoHeight || 0;

                const sizeBytes = file.size;
                const sizeMB    = sizeBytes / 1024 / 1024;

                const issues = [];

                if (sizeBytes > MAX_SIZE_BYTES) {
                    issues.push('Plik przekracza dopuszczalny rozmiar 2 GB.');
                }

                if (duration && duration > MAX_DURATION_SEC) {
                    issues.push('Czas trwania przekracza 20 minut.');
                }

                if (width && height && (width < 1280 || height < 720)) {
                    issues.push('Rozdzielczość jest niższa niż 1280x720 (zalecane minimum HD).');
                }

                let qualityNote = '';
                if (width && height) {
                    if (width === RECOMM_WIDTH && height === RECOMM_HEIGHT) {
                        qualityNote = 'Rozdzielczość zgodna z rekomendacją (1920x1080).';
                    } else if (width >= 1280 && height >= 720) {
                        qualityNote = 'Rozdzielczość akceptowalna (min. HD).';
                    } else {
                        qualityNote = 'Rozdzielczość poniżej rekomendacji – rozważ eksport w co najmniej 1920x1080.';
                    }
                }

                const status = issues.length === 0
                    ? '<span class="badge bg-success">OK – zgodne ze standardem</span>'
                    : '<span class="badge bg-danger">Wymaga korekty</span>';

                this.summaryBox.innerHTML = `
                    <div class="card bg-dark text-light text-start">
                        <div class="row">
                            <div class="col-4 p-5 text-center">
                                <p class="mb-1" style="font-size: 80px;"><i class="bi bi-cloud-plus-fill"></i></p>
                                <p class="text-info small">Załaduj ponownie</p>
                            </div>
                            <div class="col-8">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2">${this.escapeHtml(file.name)}</h6>
                                    <p class="mb-1">
                                        Rozmiar: <strong>${sizeMB.toFixed(2)} MB</strong><br/>
                                        Czas trwania: <strong>${duration ? this.formatDuration(duration) : 'nieznany'}</strong><br/>
                                        Rozdzielczość: <strong>${width} x ${height}</strong>
                                    </p>
                                    <p class="mb-1">${qualityNote}</p>
                                    <p class="mb-1">Status: ${status}</p>
                                    ${issues.length ? `
                                        <ul class="mb-0 text-warning small">
                                            ${issues.map(i => `<li>${this.escapeHtml(i)}</li>`).join('')}
                                        </ul>
                                    ` : `
                                        <p class="mb-0 text-success small">Plik spełnia założone parametry (MP4, ≤ 20 min, ≤ 2 GB).</p>
                                    `}
                                </div>
                            </div>
                        </div>

                    </div>
                `;
                this.videoDurationSec.value = duration ? this.formatDuration(duration) : '0 min 0 s'
                this.videoWidth.value = width ? width : '0'
                this.videoHeight.value = height ? height : '0'

                
            };

            video.onerror = () => {
                URL.revokeObjectURL(url);
                this.summaryBox.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        Nie udało się odczytać metadanych wideo. Sprawdź, czy plik jest poprawnym plikiem MP4.
                    </div>
                `;
            };
        }

        // --- opcjonalnie: info o istniejącym pliku z serwera ---

        renderExistingVideoInfo() {
            this.summaryBox.innerHTML = `
                <div class="card bg-dark border-secondary text-light mb-2">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">Aktualny plik prezentacji</h6>
                        <p class="mb-0 small">
                            Źródło: <code>${this.escapeHtml(this.existingVideoUrl)}</code><br/>
                            Po wybraniu nowego pliku zostanie on wysłany zamiast obecnego.
                        </p>
                    </div>
                </div>
            `;
        }

        // --- utils ---

        getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf('.') - 1 >>> 0) + 2);
        }

        formatDuration(sec) {
            const total = Math.floor(sec);
            const m = Math.floor(total / 60);
            const s = total % 60;
            return `${m} min ${s.toString().padStart(2, '0')} s`;
        }

        escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // do użycia z formularzem – np. w submit handlerze
        getFile() {
            return this.file;
        }
    }


    // globalna mapa VideoDropBoxów (jeśli jeszcze nie masz)
    window.videoDropBox = window.videoDropBox || {};

    function prepareAndSubmitPresentation(formId, isEdit) {

        // console.log("window.videoDropBox", window.videoDropBox);
        let posClassY = 'bottom-0';
        let posClassX = isEdit ? 'end-0' : 'start-0';

        const titleEl   = document.getElementById('title_' + formId);
        const descEl    = document.getElementById('description_' + formId);
        const slotEl    = document.getElementById('slot_' + formId);
        const offerEl   = document.getElementById('OfferID_' + formId);
        const authorEl  = document.getElementById('author_' + formId);
        const targetEl  = document.getElementById('target_' + formId);
        const videodurationsecEl  = document.getElementById(formId + '-videodurationsec');
        const videowidthEl  = document.getElementById(formId + '-videowidth');
        const videoheightEl  = document.getElementById(formId + '-videoheight');
        

        if (!titleEl || !descEl || !slotEl) {
            console.error('Brak wymaganych elementów formularza (title/description/slot).');
            showToast('Formularz jest niekompletny – skontaktuj się z administratorem.', 'error', posClassY, posClassX);
            return;
        }


        const title = (titleEl.value || '').trim();
        const slot  = (slotEl.value || '').trim();
        const desc  = (descEl.innerHTML || '').trim(); // zachowujemy proste formatowanie
        const videodurationsec  = (videodurationsecEl.value || '').trim(); 
        const videowidth  = (videowidthEl.value || '').trim(); 
        const videoheight  = (videoheightEl.value || '').trim(); 

        if (!title) {
            showToast('Podaj tytuł prezentacji.', 'warning', posClassY, posClassX);
            titleEl.focus();
            return;
        }

        if (!slot) {
            showToast('Wybierz slot prezentacji (GREEN / SILVER / GOLD).', 'warning', posClassY, posClassX);
            slotEl.focus();
            return;
        }

        // w przypadku NEW wymagamy pliku wideo
        let videoFile = null;
        if (window.videoDropBox && window.videoDropBox[formId]) {
            videoFile = window.videoDropBox[formId].getFile();
        }

        if (!isEdit && !videoFile) {
            showToast('Dodając nową prezentację musisz wybrać plik wideo (MP4).', 'warning', posClassY, posClassX);
            return;
        }

            const fd = new FormData();
            fd.append('offer_id', offerEl ? (offerEl.value || '') : '');
            fd.append('is_edit', isEdit ? '1' : '0');

            fd.append('title', title);
            fd.append('description', desc);
            fd.append('slot', slot);

            fd.append('video_duration_sec', videodurationsec);
            fd.append('video_width', videowidth);
            fd.append('video_height', videoheight);


            if (authorEl) fd.append('author', authorEl.value || '');
            if (targetEl) fd.append('target', targetEl.value || '');

            if (videoFile) {
                fd.append('video_file', videoFile);
            }

            // --- PROGRESS BAR ---
            const progressContainer = document.getElementById('uploadProgress_' + formId);
            const progressBar = progressContainer 
                ? progressContainer.querySelector('.progress-bar')
                : null;

            if (progressContainer && progressBar) {
                progressContainer.classList.remove('d-none');
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', '0');
            }

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/presentation-save', true);

            // progres uploadu
            xhr.upload.onprogress = function(e) {
                if (!progressBar || !e.lengthComputable) return;
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', String(percent));
            };

            xhr.onreadystatechange = function() {
                if (xhr.readyState !== XMLHttpRequest.DONE) return;

                // schowaj pasek po chwili
                if (progressContainer && progressBar) {
                    setTimeout(function() {
                        progressContainer.classList.add('d-none');
                        progressBar.style.width = '0%';
                        progressBar.setAttribute('aria-valuenow', '0');
                    }, 700);
                }

                if (xhr.status >= 200 && xhr.status < 300) {
                    let data = null;
                    try {
                        data = JSON.parse(xhr.responseText);
                    } catch (err) {
                        console.error('Błąd parsowania odpowiedzi JSON:', err);
                        showToast('Prezentacja została zapisana, ale odpowiedź serwera jest nieprawidłowa.', 'error', posClassY, posClassX);
                        return;
                    }

                    if (data.success) {
                        showToast(data.message || 'Prezentacja została zapisana pomyślnie.', 'success', posClassY, posClassX);
                        setTimeout(function() {
                            if (!isEdit) {
                                titleEl.value = "";
                                descEl.innerHTML = "";
                                slotEl.selectedIndex = 0;
                                titleEl.blur();
                                descEl.blur();
                                slotEl.blur();
                            }
                            setTimeout(() => location.reload(), 200);
                        }, 1500);
                    } else {
                        showToast(data.message || 'Wystąpił błąd podczas zapisywania prezentacji.', 'error', posClassY, posClassX);
                    }
                } else {
                    console.error('Błąd HTTP:', xhr.status, xhr.responseText);
                    showToast('Błąd sieci / serwera podczas zapisywania prezentacji. Spróbuj ponownie.', 'error', posClassY, posClassX);
                }
            };

            xhr.onerror = function() {
                if (progressContainer && progressBar) {
                    progressContainer.classList.add('d-none');
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', '0');
                }
                showToast('Błąd połączenia podczas wysyłania prezentacji.', 'error', posClassY, posClassX);
            };

            xhr.send(fd);
        }

    // Funkcja do wypełnienia contenteditable
    function applyTemplate(elementId, value) {
        const element = document.getElementById(elementId);
        if (element && element.hasAttribute('contenteditable')) {
            // Kolorowanie nawiasów przy wypełnieniu szablonu
            const formattedValue = value.replace(/\[(.*?)\]/g, '<span style="color: #f39c12;">[$1]</span>');
            element.innerHTML = formattedValue; // Ustaw pokolorowaną zawartość
        }
    }


    function forceResync(postId, slot) {
        if (!postId || !slot) return;

        if (!confirm('Czy na pewno wymusić ponowną synchronizację dla tej prezentacji?')) {
            return;
        }

        const btn = document.getElementById(`btn_force_resync_${postId}`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-1 spin"></i> Wymuszanie...';
        }

        const formData = new URLSearchParams();
        formData.append('PostID', postId);
        formData.append('slot', slot);

        fetch('/force-resync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            body: formData.toString()
        })
        .then(response => response.json().catch(() => ({})))
        .then(data => {
            if (!data || !data.success) {
                showToast(data && data.message ? data.message : 'Nie udało się wymusić synchronizacji.', 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Wymuś ponowną synchronizację';
                }
                return;
            }

            // Informacyjnie
            showToast('Wymuszono ponowną synchronizację. RPi pobierze plik przy najbliższym cyklu.', 'success');

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Oczekuje na synchronizację';
            }

            // UI: zmień ikonkę w wierszu na "wymagana synchronizacja"
            updateRowSyncIconPending(postId);

            // odpal monitor statusu
            startSyncStatusMonitor(postId);
        })
        .catch(err => {
            console.error('forceResync error:', err);
            showToast('Wystąpił błąd po stronie przeglądarki / sieci.', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Wymuś ponowną synchronizację';
            }
        });
    }

    function startSyncStatusMonitor(postId) {
        if (syncMonitors[postId]) {
            // już działa – nie dublujemy timerów
            return;
        }

        const startedAt = Date.now();

        const handle = setInterval(() => {
            const elapsed = Date.now() - startedAt;
            if (elapsed > SYNC_POLL_TIMEOUT) {
                clearInterval(handle);
                delete syncMonitors[postId];
                console.warn('Monitoring synchronizacji przekroczył limit czasu dla PostID=' + postId);
                return;
            }

            fetch(`/presentation-sync-status?PostID=${encodeURIComponent(postId)}`, {
                method: 'GET'
            })
            .then(resp => resp.json().catch(() => ({})))
            .then(payload => {
                if (!payload || !payload.success || !payload.data) {
                    return;
                }

                const d = payload.data;

                // Aktualizacja UI na podstawie danych z backendu
                updateRowSyncIconFromData(postId, d);
                updateStatusCardFromData(postId, d);

                // Zakończ monitor, jeśli:
                // - mamy sukces synchronizacji aktywnej prezentacji
                if (d.status === 1 && d.sync === 1 && d.last_sync_status === 'success') {
                    clearInterval(handle);
                    delete syncMonitors[postId];

                    const btn = document.getElementById(`btn_force_resync_${postId}`);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Wymuś ponowną synchronizację';
                    }
                }

                // Można też zakończyć przy stałym errorze:
                if (d.last_sync_status === 'error') {
                    clearInterval(handle);
                    delete syncMonitors[postId];
                    showToast('Synchronizacja zakończyła się błędem – sprawdź szczegóły w statusie.', 'error');
                    const btn = document.getElementById(`btn_force_resync_${postId}`);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Wymuś ponowną synchronizację';
                    }
                }
            })
            .catch(err => {
                console.error('presentation-sync-status error:', err);
            });

        }, SYNC_POLL_INTERVAL);

        syncMonitors[postId] = handle;
    }

    
    function refreshSyncStatus(postId) {
        const url = `/presentation-sync-status?PostID=${encodeURIComponent(postId)}`;

        return fetch(url)
            .then(async (resp) => {
                if (!resp.ok) {
                    const text = await resp.text();
                    console.warn('refreshSyncStatus HTTP error:', resp.status, text);
                    return null;
                }

                let data;
                try {
                    data = await resp.json();
                } catch (e) {
                    console.warn('refreshSyncStatus JSON parse error:', e);
                    return null;
                }

                if (!data || !data.success || !data.data) {
                    console.warn('refreshSyncStatus API error:', data && data.message);
                    return null;
                }

                // tu używamy Twojej logiki
                updateRowSyncIconFromData(postId, data.data);
                return data.data;
            })
            .catch((err) => {
                console.error('refreshSyncStatus fetch exception:', err);
                return null;
            });
    }


    function hideAllSyncIcons(postId) {
        const ids = [
            `sync_status_disconnected_${postId}`,
            `sync_status_pending_inactive_${postId}`,
            `sync_status_pending_active_${postId}`,
            `sync_status_pending_disconnect_${postId}`,
            `sync_status_ok_${postId}`,
            `sync_status_unknown_${postId}`
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('d-none');
            }
        });
    }

    function showIconById(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('d-none');
        }
    }

    function updateRowSyncIconPending(postId) {
        hideAllSyncIcons(postId);
        showIconById(`sync_status_pending_active_${postId}`);
    }
    
    function getRemainingSecondsForPost(postId) {
        const startTs = syncCountdowns[postId];
        if (!startTs) return SYNC_COUNTDOWN_SECONDS;
        const elapsed = Math.floor((Date.now() - startTs) / 1000);
        return SYNC_COUNTDOWN_SECONDS - elapsed;
    }

    function formatSeconds(sec) {
        if (sec < 0) sec = 0;
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function updateRowSyncIconFromData(postId, d) {
        const rowEl = document.getElementById(`sync_status_row_${postId}`);
        if (!rowEl) return;

        const status = Number(d.status);
        const sync   = Number(d.sync);
        const publishedAt    = d.published_at;
        const lastSyncStatus = d.last_sync_status;

        let html = '';

        // 4. Rozłączony – był kiedyś opublikowany i ma status disconnected
        if (lastSyncStatus === 'disconnected' && publishedAt && status === 0) {
            html = `
                <span class="text-danger"
                    id="sync_status_disconnected_${postId}"
                    title="Rozłączony">
                    <i class="bi bi-plug-fill"></i>
                </span>
            `;
        }
        // 1. Nieaktywny + nigdy nie zsynchronizowany
        else if (status === 0 && sync === 0 && !publishedAt) {
            html = `
                <span class="text-secondary"
                    id="sync_status_pending_inactive_${postId}"
                    title="Oczekuje na pierwszą synchronizację">
                    <i class="bi bi-hourglass-split"></i>
                </span>
            `;
        }
        // 2. Aktywny + niezsynchronizowany + ODLICZANIE
        else if (status === 1 && sync === 0) {

            // jeżeli jeszcze nie ma startu licznika, ustawiamy
            if (!syncCountdowns[postId]) {
                syncCountdowns[postId] = Date.now();
            }
            const remaining = getRemainingSecondsForPost(postId);
            const label     = formatSeconds(remaining);

            html = `
                <span class="text-info"
                    id="sync_status_pending_active_${postId}"
                    title="Wymagana synchronizacja – oczekiwanie na RPi">
                    <i class="bi bi-arrow-repeat"></i>
                    <small class="ms-1" id="sync_countdown_${postId}">${label}</small>
                </span>
            `;
        }
        // 5. W trakcie odłączania (status=0, ale nie disconnected, ma published_at)
        else if (status === 0 && lastSyncStatus !== 'disconnected' && publishedAt) {
            html = `
                <span class="text-muted"
                    id="sync_status_pending_disconnect_${postId}"
                    title="Odłączanie slotu">
                    <i class="bi bi-arrow-repeat"></i>
                </span>
            `;
        }
        // 3. Zsynchronizowany + aktywny
        else if (status === 1 && sync === 1) {
            html = `
                <span class="text-success"
                    id="sync_status_ok_${postId}"
                    title="Zsynchronizowano">
                    <i class="bi bi-check-circle"></i>
                </span>
            `;
        }
        // fallback
        else {
            html = `
                <span class="text-muted"
                    id="sync_status_unknown_${postId}"
                    title="Nieznany status">
                    <i class="bi bi-question-circle"></i>
                </span>
            `;
        }

        rowEl.innerHTML = html;
    }

    function setTextOrBrak(id, value, brakText = 'brak') {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value ? value : brakText;
    }

    function updateStatusCardFromData(postId, d) {
        setTextOrBrak(`published_at_${postId}`, d.published_at);
        setTextOrBrak(`last_sync_at_${postId}`, d.last_sync_at);
        setTextOrBrak(`last_sync_status_${postId}`, d.last_sync_status, 'brak danych');
        setTextOrBrak(`last_sync_error_${postId}`, d.last_sync_error, 'brak');

        // tu można też pogrzebać w klasach card_class, ale to już level 2 :)
    }

    
    function initSyncPolling(intervalMs = 15000) {  // np. co 15 sekund
        const rowEls = document.querySelectorAll('[data-presentation-id]');
        const ids = Array.from(rowEls).map(el => el.getAttribute('data-presentation-id'));

        if (!ids.length) {
            console.warn('initSyncPolling: brak wierszy prezentacji na stronie');
            return;
        }

        // pierwszy refresh od razu po załadowaniu
        ids.forEach(id => refreshSyncStatus(id));

        // cykliczny polling
        setInterval(() => {
            ids.forEach(id => refreshSyncStatus(id));
        }, intervalMs);
    }

</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        initSyncPolling(15000); // co 15s, możesz dać 10000 albo 30000
    });

    document.addEventListener('DOMContentLoaded', function () {

    // ... tu możesz mieć initSyncPolling(...)

    // globalne odliczanie dla wszystkich postów w stanie "aktywny + niezsynchronizowany"
    setInterval(function () {
        const ids = Object.keys(syncCountdowns);
        if (!ids.length) return;

        ids.forEach(postId => {
            const remaining = getRemainingSecondsForPost(postId);
            const label = formatSeconds(remaining);

            const el = document.getElementById(`sync_countdown_${postId}`);
            if (el) {
                el.textContent = label;
            }

            if (remaining <= 0) {
                // zakładamy, że w tym czasie RPi już powinno coś zrobić
                // więc odświeżamy stronę
                location.reload();
            }
        });
    }, 1000);
});

</script>
{% endblock %}
